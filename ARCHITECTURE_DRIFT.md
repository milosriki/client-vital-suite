# ARCHITECTURE DRIFT DETECTION REPORT

> Generated by Claude Agent - Phase 1 Logic & Intent Audit
> Date: 2025-12-19

## Summary

| Drift Category | Severity | Items | Status |
|----------------|----------|-------|--------|
| AI Agent Evolution | HIGH | 7 implementations | Needs consolidation |
| Dashboard Components | HIGH | 4 InterventionTracker variants | Needs merge |
| Query Key Migration | MEDIUM | 17% complete | In progress |
| Realtime Subscriptions | MEDIUM | 22 channels, overlap detected | Review needed |
| Sync Status Components | LOW | 2 duplicates | Easy fix |

---

## AI Agent Evolution (7 Implementations)

### Timeline & Intent

| Generation | Function | Model | Status | Original Intent |
|------------|----------|-------|--------|-----------------|
| Gen 1 | `ptd-agent` | OpenAI GPT-4 | DEPRECATED | First AI assistant attempt |
| Gen 2 | `ptd-agent-gemini` | Gemini 2.5 Flash | ACTIVE PRIMARY | Cost optimization, faster responses |
| Gen 3 | `ptd-agent-claude` | Claude Sonnet 4 | ACTIVE BACKUP | Quality improvement for complex queries |
| Gen 4 | `smart-agent` | Multi-model | ACTIVE ALTERNATIVE | 13+ tools, modular architecture |
| Gen 5 | `agent-orchestrator` | N/A | DEPRECATED | Multi-agent coordination attempt |
| Gen 6 | `super-agent-orchestrator` | Multi-model | ACTIVE | "Bulletproof" 69-function orchestrator |
| Gen 7 | `ai-ceo-master` | Claude + Gemini | ACTIVE | Executive-level multi-persona agent |

### Drift Analysis

**Original Vision:** Single AI assistant (ptd-agent)

**Current State:** 7 parallel implementations with overlapping functionality

**Root Cause:**
- Cost pressures drove Gemini adoption
- Quality concerns brought Claude in
- Complexity led to orchestrator pattern
- Each iteration added rather than replaced

**Recommendation:**
- Consolidate to 3 agents maximum:
  1. `ptd-agent-gemini` - Fast, daily operations
  2. `super-agent-orchestrator` - Complex multi-step tasks
  3. `ai-ceo-master` - Strategic decisions
- Delete: `ptd-agent`, `agent-orchestrator`

---

## Dashboard Component Duplication

### InterventionTracker Family (4 Versions)

| File | Lines | Features | Used In |
|------|-------|----------|---------|
| `components/InterventionTracker.tsx` | 89 | Basic list | Nowhere (original) |
| `dashboard/InterventionTracker.tsx` | 112 | + QUERY_KEYS | Nowhere (iteration 1) |
| `dashboard/EnhancedInterventionTracker.tsx` | 318 | + Timeline UI, status groups | Nowhere (best features) |
| `dashboard/DashboardInterventionTracker.tsx` | 156 | Self-fetching, compact | Dashboard.tsx |

**Drift Pattern:**
- Started simple (89 lines)
- Added features incrementally (new file each time)
- Never deleted old versions
- Only latest version actually used

**Recommendation:**
- Keep: `DashboardInterventionTracker.tsx` (actively used)
- Keep: `EnhancedInterventionTracker.tsx` (best UI for detail view)
- Delete: Both plain `InterventionTracker.tsx` files

### Other Duplicates

| Pair | Drift Type | Action |
|------|------------|--------|
| `SyncStatusBadge` vs `HubSpotSyncStatus` | Parallel development | Merge into SyncStatusBadge |
| `QuickActions` vs `QuickActionsPanel` | Iteration | Delete QuickActions |
| `MetricCard` (3 versions) | Scope creep | Refactor to single parametric |
| `ErrorMonitor` vs `ErrorMonitorPanel` | Mode split | Keep both (different modes) |

---

## Query Key Migration (17% Complete)

### Current State

| Pattern | Count | Percentage |
|---------|-------|------------|
| Modern QUERY_KEYS import | 19 | 17% |
| Inline string keys | 93 | 83% |

### Files Using QUERY_KEYS Pattern

```
src/components/dashboard/DashboardInterventionTracker.tsx
src/components/dashboard/InterventionTracker.tsx
src/hooks/useStripeData.ts
src/hooks/useInterventions.ts
... (15 more files)
```

### Files Still Using Inline Keys

```
src/pages/Dashboard.tsx - ['dashboardStats']
src/pages/Clients.tsx - ['clients']
src/components/KPIGrid.tsx - ['kpiData']
... (90 more files)
```

**Original Intent:** Centralize all query keys for cache invalidation consistency

**Drift:** Started migration, got distracted, left 83% incomplete

**Recommendation:** Complete migration in single pass (2-3 hours)

---

## Realtime Subscription Architecture

### 22 Channels Detected

| Category | Channels | Overlap Risk |
|----------|----------|--------------|
| Health Scores | 3 | HIGH - same table, different hooks |
| Interventions | 2 | MEDIUM - similar functionality |
| Notifications | 2 | LOW - different purposes |
| Client Activity | 4 | MEDIUM - could consolidate |
| Dashboard Stats | 5 | HIGH - multiple widgets watching same data |
| Sync Status | 3 | LOW |
| AI/PTD | 3 | LOW |

### Overlapping Subscriptions (Waste)

| Hook 1 | Hook 2 | Same Table | Action |
|--------|--------|------------|--------|
| `useRealtimeHealthScores` | `useHealthData` | client_health_scores | Merge |
| `useDashboardStats` | `useKPIData` | health_calculations | Review |
| `useClientActivity` | `useClientUpdates` | clients | Merge |

### Missing Cleanup (Memory Leaks)

| File | Issue |
|------|-------|
| NotificationCenter.tsx | Missing dependency in useEffect cleanup |
| useRealtimeHealthScores.ts | Debounce function not cleared |

---

## Frontend-Backend Alignment

### Edge Function Categories

| Category | Local | Deployed | Gap |
|----------|-------|----------|-----|
| AI/Agent | 12 | 15 | 3 ghost functions |
| HubSpot | 8 | 12 | 4 ghost functions |
| Stripe | 9 | 11 | 2 ghost functions |
| CallGear | 5 | 5 | Aligned |
| Utility | 14 | 18 | 4 ghost functions |
| Webhook | 5 | 5 | Aligned |
| Analytics | 15 | 45 | 30 ghost functions |

**Ghost Functions:** 43 functions deployed but not in local codebase

**Possible Causes:**
1. Old deployments never cleaned up
2. Functions from different branch
3. Direct Supabase dashboard uploads

**Recommendation:** Audit deployed functions, delete ghosts

---

## Configuration Drift

### config.toml vs Reality

**8 Functions Missing from config.toml (FIXED)**

```toml
# These were missing and have been added:
[functions.cleanup-fake-contacts]
[functions.hubspot-analyzer]
[functions.hubspot-live-query]
[functions.hubspot-webhook]
[functions.smart-coach-analytics]
[functions.stripe-history]
[functions.stripe-payout-controls]
[functions.super-agent-orchestrator]
```

**Status:** Fixed in branch `claude/final-improvements-a-plus-fZLqv`, pending merge

---

## Historical Drift Markers

### Evidence of Old Project Ideas

| Marker | Location | Original Intent | Current Status |
|--------|----------|-----------------|----------------|
| `TodaySnapshot.tsx` | dashboard/ | Daily summary widget | Replaced by LiveActivityFeed |
| `GreetingBar.tsx` | dashboard/ | Personalized greeting | Replaced by MissionControlHeader |
| `HeroStatCard.tsx` | dashboard/ | Animated stat display | Never integrated, KPIGrid used |
| `FilterControls.tsx` | dashboard/ | Dashboard filters | Incomplete, Tabs pattern used |
| `FloatingAIButton.tsx` | components/ | AI trigger button | Absorbed into FloatingChat |

### Evidence of Parallel Experiments

| Experiment | Files | Outcome |
|------------|-------|---------|
| Voice Chat | AIAssistantPanel.tsx | Orphaned - never integrated |
| File Upload AI | PTDControlChat.tsx | Orphaned - never connected |
| Proactive Insights | ProactiveInsightsPanel.tsx | Orphaned - learning loop broken |
| Super Orchestrator UI | useSuperAgentOrchestrator.ts | Hook created, no UI built |

---

## Drift Impact Assessment

### Technical Debt Accumulated

| Category | Debt Level | Cleanup Effort |
|----------|------------|----------------|
| Dead AI Agents | HIGH | 2 hours (delete + test) |
| Duplicate Components | HIGH | 4 hours (merge + refactor) |
| Query Key Migration | MEDIUM | 3 hours (systematic update) |
| Realtime Overlap | MEDIUM | 2 hours (consolidate hooks) |
| Ghost Functions | LOW | 1 hour (Supabase cleanup) |

### Risk Matrix

| Drift Type | Probability of Bug | Impact | Priority |
|------------|-------------------|--------|----------|
| Duplicate components | HIGH | Data inconsistency | P1 |
| Overlapping subscriptions | MEDIUM | Performance, memory | P2 |
| Incomplete migrations | LOW | Maintainability | P3 |
| Ghost functions | LOW | Confusion, billing | P4 |

---

## Recommended Consolidation Plan

### Phase 1: Immediate (Day 1)
1. Delete deprecated AI agents (`ptd-agent`, `agent-orchestrator`)
2. Merge InterventionTracker variants (4 -> 2)
3. Fix 8 missing config.toml entries (already done)

### Phase 2: Short-term (Week 1)
4. Complete QUERY_KEYS migration (17% -> 100%)
5. Consolidate overlapping realtime subscriptions
6. Merge duplicate sync status components

### Phase 3: Medium-term (Week 2-3)
7. Audit and delete ghost functions from Supabase
8. Recover valuable logic from orphan components
9. Document intentional architecture decisions

---

## Architecture Decision Records Needed

| ADR | Topic | Decision Needed |
|-----|-------|-----------------|
| ADR-001 | AI Agent Strategy | Which 3 agents to keep? |
| ADR-002 | Component Deduplication | Standard naming pattern? |
| ADR-003 | Query Key Pattern | Mandatory QUERY_KEYS? |
| ADR-004 | Realtime Strategy | One hook per table? |
| ADR-005 | Orphan Recovery | Which logic to extract? |

---

## Summary Statistics

```
TOTAL DRIFT ITEMS ANALYZED: 47

AI Evolution Drift:        7 agents (consolidate to 3)
Component Duplicates:     12 pairs (merge 8, keep 4)
Migration Incomplete:     83% of query keys
Subscription Overlap:      6 pairs (merge 4)
Ghost Functions:          43 deployed-only
Config Misalignment:       8 (FIXED)
```

---

*Report generated by Claude Agent - Architecture Drift Detection*
