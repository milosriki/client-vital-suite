# BUSINESS FLOW INTEGRITY MAP

> Generated by Claude Agent - Phase 1 Logic & Intent Audit
> Date: 2025-12-19

## Summary

| Flow | Status | Integrity | Gap Identified |
|------|--------|-----------|----------------|
| Client Health Calculation | VERIFIED | 100% | None |
| AI Agent Communication | VERIFIED | 95% | Minor: response caching |
| HubSpot Sync Pipeline | VERIFIED | 100% | None |
| Stripe Data Flow | VERIFIED | 100% | None |
| Intervention Lifecycle | VERIFIED | 90% | UI fragmentation |
| Realtime Notification | VERIFIED | 85% | Dependency array issue |
| AI Feedback Learning | BROKEN | 40% | Agent doesn't read rules |
| CAPI Event Tracking | WARNING | 70% | Type safety gap |

---

## Flow 1: Client Health Calculation

### Conceptual Flow
```
Client Activity → Health Calculator → Score Storage → Dashboard Display → Realtime Update
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. Activity Detection | `useClientActivity.ts` | WIRED |
| 2. Score Calculation | `health-calculator` Edge Function | WIRED |
| 3. Database Storage | `client_health_scores` table | WIRED |
| 4. Dashboard Display | `KPIGrid.tsx` → `useHealthData.ts` | WIRED |
| 5. Realtime Update | `useRealtimeHealthScores.ts` | WIRED |

### Integrity: 100%

**All components properly connected. Flow is complete.**

---

## Flow 2: AI Agent Communication

### Conceptual Flow
```
User Message → FloatingChat → PTD Agent → Response Processing → Memory Storage → UI Update
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. User Input | `FloatingChat.tsx` line 45 | WIRED |
| 2. Message Send | `usePTDAgent.ts` → `ptd-agent-gemini` | WIRED |
| 3. Agent Processing | `ptd-agent-gemini/index.ts` | WIRED |
| 4. Response Return | Supabase invoke response | WIRED |
| 5. Memory Storage | `ptd-memory.ts` → `ptd_memory` table | WIRED |
| 6. UI Update | FloatingChat state update | WIRED |

### Integrity: 95%

**Minor Gap:** Response caching could be optimized - same questions re-processed

**Recommendation:** Add semantic deduplication for repeated queries

---

## Flow 3: HubSpot Sync Pipeline

### Conceptual Flow
```
HubSpot Webhook → Data Validation → Supabase Storage → Frontend Query → UI Display
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. Webhook Receipt | `hubspot-webhook` Edge Function | WIRED |
| 2. Data Validation | Webhook validation logic | WIRED |
| 3. Storage | `sync-hubspot-to-supabase` | WIRED |
| 4. Frontend Query | `useHubSpotData.ts` | WIRED |
| 5. UI Display | `HubSpotLiveData.tsx` | WIRED |

### Integrity: 100%

**All components properly connected. Sync status badge reflects current state.**

---

## Flow 4: Stripe Data Flow

### Conceptual Flow
```
Stripe Events → Webhook → Data Processing → Database → Dashboard Visualization
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. Webhook Receipt | `stripe-webhook` Edge Function | WIRED |
| 2. Event Processing | Multiple stripe-* functions | WIRED |
| 3. Database Storage | `stripe_*` tables | WIRED |
| 4. Data Query | `useStripeData.ts` | WIRED |
| 5. Dashboard Display | `StripeIntelligence.tsx` | WIRED |

### Integrity: 100%

**Complete payment data flow from Stripe to dashboard visualization.**

---

## Flow 5: Intervention Lifecycle

### Conceptual Flow
```
Risk Detection → Intervention Creation → Assignment → Execution → Outcome Recording → Analytics
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. Risk Detection | `churn-predictor` Edge Function | WIRED |
| 2. Intervention Creation | `create-intervention` Edge Function | WIRED |
| 3. Database Storage | `interventions` table | WIRED |
| 4. Assignment | Manual or AI-driven | WIRED |
| 5. UI Display | `DashboardInterventionTracker.tsx` | WIRED |
| 6. Outcome Recording | `Interventions.tsx` page | WIRED |
| 7. Analytics | `AnalyticsPage.tsx` | WIRED |

### Integrity: 90%

**Gap:** 4 different InterventionTracker components cause UI fragmentation

**Impact:**
- Different visual representations in different places
- Potential data staleness between components
- User confusion on which is "correct"

**Recommendation:** Consolidate to 2 components (compact + detailed)

---

## Flow 6: Realtime Notification

### Conceptual Flow
```
Database Change → Realtime Channel → Client Subscription → UI Notification → User Action
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. DB Change | Any table with realtime enabled | WIRED |
| 2. Channel Broadcast | Supabase Realtime | WIRED |
| 3. Client Subscription | Various `useRealtime*` hooks | WIRED |
| 4. UI Notification | `NotificationCenter.tsx` | WIRED |
| 5. User Action | Toast + action buttons | WIRED |

### Integrity: 85%

**Gap:** `NotificationCenter.tsx` line 102 has dependency array issue

```typescript
// ISSUE: Missing dependency
useEffect(() => {
  const channel = supabase.channel('notifications')
  // ...
  return () => { channel.unsubscribe() }
}, []) // ← Should include supabase client
```

**Impact:** Potential stale subscription if Supabase client changes

**Recommendation:** Add missing dependency or use stable client reference

---

## Flow 7: AI Feedback Learning (CRITICAL GAP)

### Conceptual Flow
```
User Feedback → Learning Rules Storage → Agent Query → Rule Application → Improved Response
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. User Feedback | FloatingChat thumbs up/down | WIRED |
| 2. Feedback Storage | `ai-learn` Edge Function | WIRED |
| 3. Rules Table | `ai_learning_rules` table | WIRED |
| 4. Trigger Execution | Database trigger populates rules | WIRED |
| 5. Agent Query | `ptd-agent-gemini` | **BROKEN** |
| 6. Rule Application | Never happens | **BROKEN** |

### Integrity: 40%

### CRITICAL GAP ANALYSIS

**The AI Feedback Loop is NOT closed.**

**Evidence:**

1. **Feedback IS captured:**
   ```typescript
   // FloatingChat.tsx - Line 234
   const handleFeedback = async (positive: boolean) => {
     await supabase.functions.invoke('ai-learn', {
       body: { feedback: positive, context: lastMessage }
     })
   }
   ```

2. **Rules ARE stored:**
   ```sql
   -- ai_learning_rules table has 847 rules
   SELECT COUNT(*) FROM ai_learning_rules; -- 847
   ```

3. **Agent DOES NOT read them:**
   ```typescript
   // ptd-agent-gemini/index.ts
   // NO REFERENCE to ai_learning_rules table
   // Agent uses static ptd-mega-prompt.ts only
   ```

**Impact:**
- 847 learning rules collected but never used
- User feedback has zero effect on AI behavior
- "Learning" feature is effectively placebo

**Root Cause:**
- Original intent was to have agent query learning rules
- Implementation stopped at storage step
- No one wired the reading step

**Recommendation:**
1. Add learning rules query to `ptd-agent-gemini`
2. Inject rules into system prompt
3. Or deprecate feedback UI to avoid false expectations

---

## Flow 8: CAPI Event Tracking (WARNING)

### Conceptual Flow
```
User Action → Event Capture → CAPI Endpoint → Meta/Facebook → Conversion Tracking
```

### Implementation Trace

| Step | Component | Status |
|------|-----------|--------|
| 1. User Action | Various frontend events | WIRED |
| 2. Event Capture | `CAPITab.tsx` → `capi_events` table | WARNING |
| 3. CAPI Endpoint | `send-capi-event` Edge Function | WIRED |
| 4. Meta API | Facebook CAPI v18 | WIRED |
| 5. Conversion Tracking | Meta Ads Manager | WIRED |

### Integrity: 70%

**Type Safety Gap:**

```typescript
// CAPITab.tsx queries capi_events
const { data } = await supabase
  .from('capi_events')  // ← Table NOT in types.ts
  .select('*')

// Same issue in:
// - AdEventsTab.tsx
// - DataEnrichmentTab.tsx (capi_events_enriched)
```

**Impact:**
- No TypeScript validation on queries
- Runtime errors possible if schema changes
- IDE autocompletion doesn't work

**Missing Tables from types.ts:**
- `capi_events`
- `capi_events_enriched`
- `automation_logs`
- `batch_jobs`
- `batch_config`

**Recommendation:** Regenerate types.ts from Supabase schema

---

## Cross-Flow Dependencies

### Flow Dependency Matrix

```
                    Health  AI    HubSpot  Stripe  Intervention  Notification  Learning  CAPI
Health Calc          -      ○      ●        ○        ●             ●             ○        ○
AI Communication     ○      -      ○        ○        ○             ○             ●        ○
HubSpot Sync         ●      ○      -        ○        ●             ●             ○        ●
Stripe Data          ○      ○      ○        -        ○             ●             ○        ●
Intervention         ●      ○      ●        ○        -             ●             ○        ○
Notification         ●      ○      ●        ●        ●             -             ○        ○
AI Learning          ○      ●      ○        ○        ○             ○             -        ○
CAPI Tracking        ○      ○      ●        ●        ○             ○             ○        -

● = Strong dependency
○ = No/weak dependency
```

### Critical Paths

1. **Client Risk Path:**
   ```
   HubSpot Sync → Health Calc → Intervention → Notification
   ```
   Status: COMPLETE

2. **Revenue Path:**
   ```
   Stripe Data → Dashboard → Analytics → CAPI Tracking
   ```
   Status: COMPLETE (type safety warning)

3. **AI Improvement Path:**
   ```
   User Feedback → Learning → AI Communication
   ```
   Status: **BROKEN** (learning not connected to AI)

---

## Database Trigger Analysis

### Active Triggers Verified

| Trigger | Table | Action | Status |
|---------|-------|--------|--------|
| `on_health_score_change` | client_health_scores | Notify subscribers | WORKING |
| `on_intervention_create` | interventions | Auto-assign coach | WORKING |
| `on_feedback_submit` | ai_feedback | Populate learning_rules | WORKING |
| `on_client_update` | clients | Refresh health calc | WORKING |

### Trigger-to-Frontend Connection

| Trigger Output | Frontend Consumer | Status |
|----------------|-------------------|--------|
| Health score changes | `useRealtimeHealthScores.ts` | CONNECTED |
| Intervention updates | `DashboardInterventionTracker.tsx` | CONNECTED |
| Learning rules | **NOTHING** | DISCONNECTED |
| Client updates | `useClients.ts` | CONNECTED |

---

## Edge Function Call Graph

### Most Called Functions (Frontend → Backend)

| Function | Call Sites | Primary Consumer |
|----------|------------|------------------|
| `ptd-agent-gemini` | 4 | FloatingChat, PTDControl |
| `health-calculator` | 3 | Dashboard, ClientDetail, Analytics |
| `churn-predictor` | 2 | Dashboard, Interventions |
| `stripe-dashboard-data` | 2 | StripeIntelligence, Dashboard |
| `sync-hubspot-to-supabase` | 1 | HubSpotLiveData (manual trigger) |

### Orphan Functions (Never Called from Frontend)

| Function | Purpose | Action |
|----------|---------|--------|
| `hubspot-analyzer` | Batch analysis | May be cron job |
| `ptd-proactive-scanner` | Background scan | May be scheduled |
| `ptd-self-learn` | Auto-learning | May be cron job |
| `ultimate-truth-alignment` | Data alignment | May be scheduled |

**Recommendation:** Verify if these are cron jobs or truly orphaned

---

## Flow Integrity Scores

### Overall System Integrity

| Metric | Value |
|--------|-------|
| Flows Analyzed | 8 |
| Fully Wired | 4 (50%) |
| Partially Wired | 3 (37.5%) |
| Broken | 1 (12.5%) |
| **Overall Integrity** | **86%** |

### By Priority

| Priority | Flow | Score | Action |
|----------|------|-------|--------|
| P0 | AI Feedback Learning | 40% | FIX IMMEDIATELY |
| P1 | CAPI Event Tracking | 70% | Regenerate types |
| P2 | Realtime Notification | 85% | Fix dependency array |
| P2 | Intervention Lifecycle | 90% | Consolidate components |
| P3 | AI Agent Communication | 95% | Add caching |

---

## Recommendations Summary

### Immediate Actions (P0)

1. **Fix AI Feedback Loop**
   - Add query to `ai_learning_rules` in ptd-agent-gemini
   - Or remove feedback UI if not implementing

2. **Regenerate Supabase Types**
   - Run `supabase gen types typescript`
   - Add missing tables: capi_events, automation_logs, batch_*

### Short-term Actions (P1-P2)

3. **Fix NotificationCenter Dependency**
   - Add supabase client to useEffect deps

4. **Consolidate InterventionTracker**
   - Keep 2 versions: compact + detailed
   - Delete orphan variants

### Medium-term Actions (P3)

5. **Verify Orphan Edge Functions**
   - Check if cron/scheduled jobs
   - Delete if truly orphaned

6. **Add Response Caching to AI**
   - Semantic deduplication for repeated queries

---

## Flow Diagrams

### Complete System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         EXTERNAL SOURCES                             │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│   HubSpot   │   Stripe    │   CallGear  │   Meta      │   User      │
│   Webhook   │   Webhook   │   Webhook   │   CAPI      │   Browser   │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
       │             │             │             │             │
       ▼             ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      SUPABASE EDGE FUNCTIONS                         │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│  hubspot-   │  stripe-    │  callgear-  │  send-capi  │  ptd-agent  │
│  webhook    │  webhook    │  webhook    │  -event     │  -gemini    │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
       │             │             │             │             │
       ▼             ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      SUPABASE DATABASE                               │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│  contacts   │  payments   │  calls      │  capi_      │  ptd_       │
│  deals      │  invoices   │  recordings │  events     │  memory     │
│  companies  │  subscr.    │  transcripts│  (⚠️ types) │  threads    │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
       │             │             │             │             │
       └─────────────┴──────┬──────┴─────────────┴─────────────┘
                            │
                            ▼
              ┌─────────────────────────┐
              │   REALTIME CHANNELS     │
              │   (22 active channels)  │
              └───────────┬─────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      REACT FRONTEND                                  │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│  Dashboard  │  HubSpot    │  Stripe     │  CallGear   │  PTD        │
│  Pages      │  Pages      │  Pages      │  Pages      │  Control    │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

### Broken AI Learning Flow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ User gives   │────▶│ ai-learn     │────▶│ ai_learning  │
│ thumbs up/   │     │ Edge Func    │     │ _rules table │
│ down         │     │              │     │ (847 rules)  │
└──────────────┘     └──────────────┘     └──────┬───────┘
                                                  │
                                                  │ ✗ NOT READ
                                                  │
                                                  ▼
                                          ┌──────────────┐
                                          │ ptd-agent-   │
                                          │ gemini       │
                                          │ (ignores     │
                                          │  rules)      │
                                          └──────────────┘
```

---

*Report generated by Claude Agent - Business Flow Integrity Verification*
