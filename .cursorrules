# Client Vital Suite - Cursor AI Instructions

You are an AI assistant with FULL ACCESS to the following systems via MCP servers, CLI tools, and Supabase Edge Functions.

## IMPORTANT: CLI & Secrets Management
When user asks to check CLI, verify secrets, or debug connections:
```bash
# Check all CLI connections
./check-cli-connections.sh

# Check Supabase secrets
supabase secrets list

# Set a secret
supabase secrets set KEY=value

# Verify Stripe key
curl -s https://api.stripe.com/v1/balance -u $STRIPE_SECRET_KEY:

# Deploy all functions
./deploy-all-functions.sh
```

## MCP Servers Available (mcp.json)

### 1. HubSpot Advanced (~90 tools)
```json
{
  "command": "node",
  "args": ["/Users/milosvukovic/Documents/hubspot-mcp-server/dist/server.js"],
  "env": { "HUBSPOT_ACCESS_TOKEN": "${HUBSPOT_ACCESS_TOKEN}" }
}
```
**Capabilities:**
- `hubspot_search_contacts` - Search contacts by query/filters
- `hubspot_create_contact` - Create new contacts
- `hubspot_update_contact` - Update contact properties
- `hubspot_create_engagement` - Create notes, emails, tasks, meetings, calls
- `hubspot_search_deals` - Search deals by pipeline/stage
- `hubspot_create_deal` - Create new deals
- `hubspot_move_deal_stage` - Move deals through pipeline
- `hubspot_list_owners` - Get all HubSpot owners
- `hubspot_change_owner` - Reassign contacts/deals
- `hubspot_get_associations` - Get related records
- `hubspot_create_association` - Link records together
- `hubspot_list_pipelines` - Get deal pipelines
- `hubspot_list_properties` - Get all properties
- `hubspot_enroll_in_workflow` - Add to automation workflows

**Portal:** 7973797 (PersonalTrainersDubai)

### 2. Supabase (~50 tools)
```json
{
  "command": "npx",
  "args": ["-y", "@supabase/mcp-server-supabase@latest", "--project-ref", "ztjndilxurtsfqdsvfds"]
}
```
**Capabilities:**
- `query` - SELECT from any table
- `insert` - INSERT rows
- `update` - UPDATE rows
- `delete` - DELETE rows
- `rpc` - Call database functions
- `execute_sql` - Run raw SQL
- `list_tables` - Get all tables
- `get_table_schema` - Get table structure
- `list_functions` - Edge functions list
- `invoke_function` - Call edge functions
- `list_secrets` - View secret names
- `set_secret` - Set secrets
- `list_buckets` - Storage buckets
- `upload_file` / `download_file` - File operations

**Project:** ztjndilxurtsfqdsvfds (Mumbai region)

### 3. Firebase (~40 tools)
```json
{
  "command": "npx",
  "args": ["-y", "firebase-tools", "experimental:mcp"],
  "env": { "GOOGLE_APPLICATION_CREDENTIALS": "${GOOGLE_APPLICATION_CREDENTIALS}" }
}
```
**Capabilities:**
- `firestore_get` / `firestore_set` / `firestore_query` - Firestore operations
- `auth_get_user` / `auth_create_user` - Authentication
- `storage_upload` / `storage_download` - File storage
- `functions_list` / `functions_call` - Cloud Functions
- `hosting_deploy` - Deploy hosting
- `remote_config_get` / `remote_config_set` - Remote config

### 4. Vercel (~30 tools)
```json
{
  "command": "npx",
  "args": ["-y", "vercel-mcp-server"],
  "env": { "VERCEL_TOKEN": "${VERCEL_TOKEN}" }
}
```
**Capabilities:**
- `list_deployments` / `create_deployment` - Manage deployments
- `list_projects` / `get_project` - Project management
- `list_domains` / `add_domain` - Domain management
- `list_env_vars` / `create_env_var` - Environment variables
- `get_logs` / `tail_logs` - View logs
- `redeploy` - Trigger redeployment

**Project:** client-vital-suite

## CLI Tools Available

### Supabase CLI
```bash
supabase login                    # Authenticate
supabase projects list            # List projects
supabase functions list           # List edge functions
supabase functions deploy <name>  # Deploy function
supabase secrets list             # List secrets
supabase secrets set KEY=value    # Set secret
supabase db dump                  # Export database
```

### Vercel CLI
```bash
vercel login                      # Authenticate
vercel whoami                     # Check auth
vercel link                       # Link project
vercel --prod                     # Deploy to production
vercel env pull                   # Pull env vars
vercel logs                       # View logs
```

### HubSpot CLI
```bash
hs auth                           # Authenticate
hs accounts list                  # List accounts
hs project upload                 # Upload assets
```

### Stripe CLI
```bash
stripe login                      # Authenticate
stripe listen                     # Listen for webhooks
stripe trigger <event>            # Test webhooks
stripe payments list              # List payments
stripe customers list             # List customers
stripe balance                    # Check balance
stripe payouts list               # List payouts
stripe charges list               # List charges
stripe refunds list               # List refunds
stripe disputes list              # List disputes
stripe subscriptions list         # List subscriptions
```

## üî• DEEP STRIPE INTELLIGENCE (Edge Functions)

### stripe-forensics - Complete Money Intelligence
**Invoke:** `supabase functions invoke stripe-forensics --body '{"action":"complete-intelligence","days":30}'`

**Actions:**
- `complete-intelligence` - FULL forensic analysis with all data
- `money-flow` - Track all money movements
- `full-audit` - Security audit with anomaly detection
- `events-timeline` - Recent events categorized

**What It Analyzes:**
```
INFLOWS:
‚îú‚îÄ‚îÄ Charges (payments received)
‚îú‚îÄ‚îÄ Top-ups (bank ‚Üí Stripe)
‚îú‚îÄ‚îÄ Treasury inbound transfers
‚îî‚îÄ‚îÄ Received credits

OUTFLOWS:
‚îú‚îÄ‚îÄ Payouts (Stripe ‚Üí bank)
‚îú‚îÄ‚îÄ Instant payouts (debit card)
‚îú‚îÄ‚îÄ Refunds
‚îú‚îÄ‚îÄ Transfers (to connected accounts)
‚îú‚îÄ‚îÄ Issuing card spend
‚îú‚îÄ‚îÄ Treasury outbound transfers
‚îî‚îÄ‚îÄ Treasury outbound payments
```

**Forensic Checks (Fraud Detection):**
1. `SHADOW_ADMIN_DETECTED` - External platform controlling account
2. `HIDDEN_FEE_SKIMMING` - Application fees redirecting money
3. `TRANSFER_MONEY_REDIRECT` - Funds routed to connected accounts
4. `UNAUTHORIZED_PAYOUT_DESTINATION` - Payouts to unknown bank accounts
5. `CARD_TESTING_ATTACK` - Multiple setup intents (stolen card testing)
6. `UNAUTHORIZED_IP_ACCESS` - Unknown IPs making account changes
7. `HIGH_VELOCITY_PAYOUTS` - Too many payouts in one day
8. `INSTANT_PAYOUTS` - Instant payout usage (high risk)
9. `OPEN_DISPUTES` - Unresolved chargebacks

**Security Score:** 0-100 (deducts points per anomaly severity)

**Data Retrieved:**
- Balance (available, pending, instant)
- Payouts (all with destinations, trace IDs)
- Balance Transactions (all money movements)
- Charges (with risk scores, card details)
- Refunds
- Transfers (to connected accounts)
- Top-ups
- Account info (controller detection)
- Disputes
- Customers
- Events (with IP addresses)
- Issuing (cards, transactions, authorizations)
- Treasury (financial accounts, transfers, payments)
- Terminal (readers, locations)
- Cash Balances (customer prepaid funds)

### stripe-payouts-ai - AI-Powered Payout Analysis
**Invoke:** `supabase functions invoke stripe-payouts-ai --body '{"action":"fetch-data"}'`

**Actions:**
- `fetch-data` - Get balance, payouts, transfers, transactions
- `chat` - AI chat about payouts (uses Gemini)

**AI Capabilities:**
- Answer questions about payouts, transfers, balance
- Identify suspicious or unusual transactions
- Track where money went and when
- Explain payout schedules and statuses
- Alert about failed or pending payouts
- Investigate unauthorized transfers

### stripe-payout-controls - Read-Only Dashboard
**Invoke:** `supabase functions invoke stripe-payout-controls --body '{"action":"get-dashboard"}'`

**Actions:**
- `get-dashboard` - Full overview (balance, payouts, transactions)
- `get-history` - Detailed payout history with stats
- `get-balance` - Current balance breakdown
- `get-charges` - Recent charges with daily totals
- `get-subscriptions` - Subscriptions with MRR calculation
- `list-actions` - List all available actions

**Data Provided:**
- Balance: available, pending, instant_available
- Payouts: status, method, arrival_date, failure_code
- Transactions: categorized by type
- Charges: with refund amounts
- Subscriptions: with MRR (Monthly Recurring Revenue)

### stripe-webhook - Real-time Event Handler
**Events Handled:**
- `payment_intent.succeeded/failed`
- `charge.succeeded/refunded/disputed`
- `payout.created/paid/failed`
- `customer.subscription.*`
- `invoice.paid/payment_failed`

### stripe-dashboard-data - Dashboard API
**Provides:** Transaction summaries, revenue charts, customer stats

### enrich-with-stripe - CRM Enrichment
**Function:** Adds Stripe payment data to HubSpot contacts

### stripe-history - Historical Analysis
**Function:** Deep historical payment analysis

## Database Tables (Supabase)

### Core Tables
- `contacts` - HubSpot contacts synced
- `deals` - HubSpot deals synced
- `client_health_scores` - Daily health scores (0-100)
- `call_records` - CallGear call data
- `appointments` - Calendly bookings
- `intervention_log` - Recommended actions

### Financial Tables (Stripe Deep Intelligence)
- `stripe_events` - All webhook events
- `stripe_transactions` - Payments with full details
- `stripe_subscriptions` - Subscriptions with MRR
- `stripe_invoices` - Invoice records
- `stripe_refunds` - Refund tracking
- `fraud_alerts` - Anomaly detection results
- `payout_history` - Historical payouts
- `balance_snapshots` - Balance over time

### Marketing Tables
- `attribution_events` - AnyTrack data
- `capi_events` - Meta CAPI events
- `facebook_ads_insights` - Ad performance
- `ultimate_truth_events` - Unified attribution

### AI Tables
- `agent_memory` - Conversation history
- `agent_patterns` - Learned behaviors
- `knowledge_base` - RAG embeddings
- `proactive_insights` - Generated insights

## Edge Functions (80+)

### HubSpot
- `sync-hubspot-to-supabase` - Main CRM sync
- `fetch-hubspot-live` - Real-time queries
- `hubspot-command-center` - Operations hub

### Stripe
- `stripe-webhook` - Webhook handler
- `stripe-forensics` - Anomaly detection
- `stripe-dashboard-data` - Dashboard API

### AI Agents
- `ptd-agent-claude` - Claude-based agent
- `ptd-agent-gemini` - Gemini-based agent
- `health-calculator` - Daily scoring
- `churn-predictor` - Churn analysis
- `intervention-recommender` - Action suggestions

### Marketing
- `sync-hubspot-to-capi` - Meta CAPI sync
- `process-capi-batch` - Batch processing
- `ultimate-truth-alignment` - Attribution unification

## Quick Commands

```bash
# Verify all connections
./check-cli-connections.sh

# Deploy everything
vercel --prod && ./deploy-all-functions.sh

# Test health endpoint
curl https://client-vital-suite.vercel.app/api/health

# Run a Supabase function
supabase functions invoke health-calculator

# Sync HubSpot
supabase functions invoke sync-hubspot-to-supabase
```

## Environment Variables Required

```
HUBSPOT_ACCESS_TOKEN     - HubSpot Private App token
STRIPE_SECRET_KEY        - Stripe API key
FB_ACCESS_TOKEN          - Meta access token
FB_PIXEL_ID              - Meta Pixel ID
ANTHROPIC_API_KEY        - Claude API key
GOOGLE_GEMINI_API_KEY    - Gemini API key
VERCEL_TOKEN             - Vercel API token
GOOGLE_APPLICATION_CREDENTIALS - Firebase service account
```

## When Asked To:

1. **Query CRM data** ‚Üí Use HubSpot MCP or Supabase `contacts`/`deals` tables
2. **Check payments** ‚Üí Use Stripe CLI or Supabase `stripe_*` tables
3. **Deploy changes** ‚Üí Use `vercel --prod` or `./deploy-all-functions.sh`
4. **Run AI analysis** ‚Üí Invoke `ptd-agent-claude` or `ptd-agent-gemini`
5. **Check health scores** ‚Üí Query `client_health_scores` table
6. **Debug issues** ‚Üí Run `./check-cli-connections.sh` first

## üí∞ STRIPE DEEP RESEARCH - Example Prompts

### Financial Analysis
```
"Run a complete money intelligence analysis for the last 30 days"
‚Üí supabase functions invoke stripe-forensics --body '{"action":"complete-intelligence","days":30}'

"Show me all money flows - where did money come from and go"
‚Üí supabase functions invoke stripe-forensics --body '{"action":"money-flow","days":30}'

"Run a full security audit on my Stripe account"
‚Üí supabase functions invoke stripe-forensics --body '{"action":"full-audit"}'
```

### Payout Intelligence
```
"Get my current balance and pending payouts"
‚Üí supabase functions invoke stripe-payout-controls --body '{"action":"get-dashboard"}'

"Show payout history with failure analysis"
‚Üí supabase functions invoke stripe-payout-controls --body '{"action":"get-history","limit":100}'

"Calculate my MRR from subscriptions"
‚Üí supabase functions invoke stripe-payout-controls --body '{"action":"get-subscriptions"}'
```

### Fraud Detection
```
"Check for unauthorized payouts or suspicious activity"
‚Üí Look for: UNAUTHORIZED_PAYOUT_DESTINATION, SHADOW_ADMIN_DETECTED

"Detect if someone is skimming fees from my account"
‚Üí Look for: HIDDEN_FEE_SKIMMING, TRANSFER_MONEY_REDIRECT

"Check for card testing attacks"
‚Üí Look for: CARD_TESTING_ATTACK (multiple setup intents)

"Find unknown IP addresses accessing my account"
‚Üí Look for: UNAUTHORIZED_IP_ACCESS
```

### AI-Powered Questions
```
"Ask AI: Where did my money go this month?"
‚Üí supabase functions invoke stripe-payouts-ai --body '{"action":"chat","message":"Where did my money go this month?","context":{...}}'

"Ask AI: Are there any suspicious transfers?"
‚Üí supabase functions invoke stripe-payouts-ai --body '{"action":"chat","message":"Identify any suspicious transfers or unauthorized activity"}'
```

### CLI Quick Checks
```bash
# Check current balance
stripe balance

# List recent payouts
stripe payouts list --limit 10

# List failed payments
stripe charges list --status failed --limit 20

# Check for disputes
stripe disputes list

# Listen for real-time events
stripe listen --forward-to localhost:54321/functions/v1/stripe-webhook
```

## üîê Required Secrets for Stripe

```
STRIPE_SECRET_KEY          # sk_live_... or sk_test_...
STRIPE_WEBHOOK_SECRET      # whsec_... for webhook verification
AUTHORIZED_IP_ADDRESSES    # Comma-separated IPs for forensic checks
```

Set via: `supabase secrets set STRIPE_SECRET_KEY=sk_live_xxx`
